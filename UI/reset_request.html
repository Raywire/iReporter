<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>iReporter Request Password Reset</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex,nofollow"/>
    <link rel="icon" type="image/png" href="img/favicon.ico">
    <link rel="stylesheet" href="css/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <noscript>
      <div class="column-100">
        <div class="card">
            <div class="container">
              <h1>Your browser does not support Javascript</h1> 
            </div>
          </div>               
      </div> 
    </noscript>   
    <script src="js/commons.js"></script> 
    <script src="js/loggedIn.js"></script>
  </head>
  <body>
    <nav class="navbar">
      <span class="navbar-toggle" id="js-navbar-toggle">
        <i class="fa fa-bars"></i>
      </span>
      <a href="home.html" class="logo">iReporter</a>
      <ul class="main-nav" id="js-menu">
        <li>
          <a href="contact.html"  class="nav-links">contact</a>
        </li>
        <li>
          <a href="about.html"  class="nav-links">about</a>
        </li>
        <li>
          <a href="signin.html" class="nav-links">sign in</a>
        </li>
        <li>
          <a href="signup.html" class="nav-links">sign up</a>
        </li>       
      </ul>
    </nav>
    <div class="container row wrapper">
      <div class="forgot-password">
        <div  class="modal-form">
            <form id="requestReset" method="POST">
                <p class="contact"><label for="name">Reset Password</label></p>
                <input id="useremail" name="name" placeholder="Enter Your Email or Username" maxlength="36" autocomplete="off" required="" tabindex="1" type="text">                                 
                <br>
                <input name="submit" class="button-modal" tabindex="5" value="Request Password Reset" type="submit">
                <p id="error-message"></p>
                <i id="fa-spin" class="fa fa-circle-o-notch fa-spin"></i>
            </form>      
            <script>
                document.getElementById('requestReset').addEventListener('submit', requestReset);

                function requestReset(event){
                  event.preventDefault();
                  document.getElementById('error-message').innerHTML = '';
                  document.getElementById('fa-spin').style.display = "block";

                  let useremail = document.getElementById('useremail').value;

                  let uri = config.root + 'users/' + useremail + '/resetPassword';             

                  let options = {
                      method: 'POST',
                      mode: "cors",
                      headers: new Headers({
                          "Content-Type": "application/json; charset=utf-8",
                      }),
                      body: JSON.stringify({resetlink : config.resetlink})
                  }
                  let req = new Request(uri, options);

                  fetch(req)
                      .then((response)=>{
                          if(response.ok){
                              document.getElementById('fa-spin').style.display = "none";

                              return response.json();
                          }else{
                              document.getElementById('fa-spin').style.display = "none";
                              return response.json();
                          }
                      })
                      .then( (j) =>{
                          let reset_message = `If a user account exists for ${useremail}, an email will be sent with further instructions`;
                          if(j.hasOwnProperty('message')){

                            if(j['message'].hasOwnProperty('resetlink')){
                              document.getElementById('error-message').innerHTML = 'resetlink key is missing';
                            }
                            if(j['message'] == 'user does not exist'){
                              document.getElementById('error-message').style.color = 'green';
                              document.getElementById('error-message').innerHTML = reset_message;
                              setTimeout(function(){ window.location.replace("signin.html"); }, 5000);
                            }
                            if(j['message'] == 'Reset link has been sent to your email'){
                              document.getElementById('error-message').style.color = 'green';
                              document.getElementById('error-message').innerHTML = reset_message;
                              setTimeout(function(){ window.location.replace("signin.html"); }, 5000);
                            }
                            if(j['message'] == 'Password reset failed please try again'){
                              document.getElementById('error-message').innerHTML = j['message']; 
                            }
                    
                          }
                                                      
                      })
                      .catch( (err) =>{
                          console.log(err);
                                                
                      });
                }
            </script> 
        </div>
      </div>

      <div class="push"></div>
    </div>
    <div class="footer">
      <ul>
        <li>
          <a href="contact.html"  class="nav-links">contact</a>
        </li>
        <li>
          <a href="about.html"  class="nav-links">about</a>
        </li>    
        <li><a href="#" class="nav-links">privacy & terms</a></li>    
      </ul>
    </div>
    <script src="js/main.js"></script>
  </body>
</html>
