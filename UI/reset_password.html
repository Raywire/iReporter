<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>iReporter Password Reset</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex,nofollow"/>
    <link rel="icon" type="image/png" href="img/favicon.ico">
    <link rel="stylesheet" href="css/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/notifications.css">
    <noscript>
      <div class="column-100">
        <div class="card">
            <div class="container">
              <h1>Your browser does not support Javascript</h1> 
            </div>
          </div>               
      </div> 
    </noscript>  
    <script src="js/commons.js"></script>  
    <script src="js/loggedIn.js"></script>
    <script src="js/notifications.js"></script>
  </head>
  <body>
    <nav class="navbar">
      <span class="navbar-toggle" id="js-navbar-toggle">
        <i class="fa fa-bars"></i>
      </span>
      <a href="home.html" class="logo">iReporter</a>
      <ul class="main-nav" id="js-menu">
        <li>
          <a href="contact.html"  class="nav-links">contact</a>
        </li>
        <li>
          <a href="about.html"  class="nav-links">about</a>
        </li>
        <li>
          <a href="signin.html" class="nav-links">sign in</a>
        </li>
        <li>
          <a href="signup.html" class="nav-links">sign up</a>
        </li>       
      </ul>
    </nav>
    <div class="container row wrapper">
        <div class="forgot-password">
            <div  class="modal-form">
                <form id="resetPassword" method="POST">
                    <p class="contact"><label for="title">Password</label></p>
                    <input id="password" name="password" maxlength="30" placeholder="Password" tabindex="1" type="password">
                    <p class="contact"><label for="title">Confirm Password</label></p>
                    <input id="confirm_password" name="confirm_password" maxlength="30" placeholder="Confirm Password" tabindex="1" type="password">
                    <br>
                    <input id='submit' name="submit" class="button-normal" tabindex="5" value="Reset Password" type="submit">
                    <p id="error-message"></p>
                    <i id="fa-spin-reset" class="fa fa-circle-o-notch fa-spin hide" ></i>
                </form>  
                <script>
                    let urlParams = new URLSearchParams(window.location.search);
                    let profileUserName = urlParams.get('username');
                    let token = urlParams.get('token');

                    document.getElementById('confirm_password').addEventListener('keyup', checkPassword);
                    document.getElementById('resetPassword').addEventListener('submit', (event) => resetPassword(event, profileUserName));

                    function resetPassword(event, usernameid){
                      event.preventDefault();
                      document.getElementById('fa-spin-reset').style.display = "block";

                      let uri = config.root + 'users/' + usernameid;

                      let password = document.getElementById('password').value;
                      let confirm_password = document.getElementById('confirm_password').value;

                      if (password != confirm_password){
                      document.getElementById('fa-spin-reset').style.display = "none";
                      document.getElementById('password').style.borderColor = "red";
                      document.getElementById('confirm_password').style.borderColor = "red";
                      return false;
                      }

                      let options = {
                          method: 'PATCH',
                          mode: "cors",
                          headers: new Headers({
                          "Content-Type": "application/json; charset=utf-8",
                          "x-access-token": token
                          }),
                          body: JSON.stringify({password:password})
                      }
                      let req = new Request(uri, options);

                      fetch(req)
                          .then((response)=>{
                              if(response.ok){
                              return response.json();
                              }else{
                              return response.json();
                              }
                          })
                          .then( (j) =>{
                          if(j.hasOwnProperty('message')){
                              if(j['message'] == 'Token is missing'){
                              document.getElementById('error-message').innerHTML = 'Token is missing';
                              }
                              if(j['message'] == 'Token is invalid'){
                              document.getElementById('error-message').innerHTML = 'Token is invalid or has expired';
                              }
                              if(j['message'] == 'User does not exist'){
                              warningNotification({ 
                                      title: 'Warning',
                                      message: j['message'], 
                              });
                              }
                              if(j['message'].hasOwnProperty('password')){
                                  document.getElementById('password').style.borderColor = "red";
                                  warningNotification({ 
                                      title: 'Warning',
                                      message: j['message']['password'], 
                                  });
                              }    
                              if(j['message'] == 'Only an admin or the user can update their own password'){
                              warningNotification({ 
                                      title: 'Warning',
                                      message: j['message'], 
                              });
                              }

                              if(j['message'] == 'User password has been changed'){
                              successNotification({ 
                                      title: 'Success',
                                      message: j['message'] + ' for ' + j['username'], 
                              });
                              setTimeout(function(){ window.location.replace("signin.html"); }, 3000);
                              
                              }
                          }
                      
                          document.getElementById('fa-spin-reset').style.display = "none";
                                                      
                          })
                          .catch( (err) =>{
                              console.log(err);
                              document.getElementById('fa-spin-reset').style.display = "none";
                          });
                    }                 
                </script> 
            </div>
        </div>


      <div class="push"></div>
    </div>
    <div class="footer">
      <ul>
        <li>
          <a href="contact.html"  class="nav-links">contact</a>
        </li>
        <li>
          <a href="about.html"  class="nav-links">about</a>
        </li>    
        <li><a href="#" class="nav-links">privacy & terms</a></li>    
      </ul>
    </div>
    <script src="js/main.js"></script>
  </body>
</html>
